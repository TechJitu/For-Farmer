<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agri-Climate Yield Forecaster</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px; /* Smaller spinner */
            height: 24px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
            display: inline-block; /* Keep it inline */
            margin-left: 10px; /* Space from button text */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 lg:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-xl overflow-hidden">
        <header class="bg-gradient-to-r from-green-600 to-blue-500 p-6">
            <h1 class="text-3xl font-bold text-white">Agri-Climate Yield Forecaster</h1>
            <p class="text-green-100 mt-1">Predict crop yield and estimate potential profit.</p>
        </header>

        <div class="p-6 md:p-8">
             <!-- Section 1: Yield Prediction Model -->
             <div>
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">1. Yield Prediction</h2>
                <p class="text-sm text-gray-600 mb-6">
                    Fill out all 8 fields below to predict the yield per hectare.
                </p>
                
                <!-- Form for ML Model -->
                <div id="ml-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    
                    <!-- Categorical Features -->
                    <div>
                        <label for="crop-type" class="block text-sm font-medium text-gray-700">Crop</label>
                        <select id="crop-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option>Rice</option><option>Arecanut</option><option>Arhar/Tur</option><option>Coconut </option><option>Cotton(lint)</option><option>Dry chillies</option><option>Groundnut</option><option>Jute</option><option>Maize</option><option>Moong(Green Gram)</option><option>Sesamum</option><option>Sugarcane</option><option>Urad</option><option>Wheat</option><option>Other Kharif pulses</option>
                        </select>
                    </div>

                    <div>
                        <label for="season-type" class="block text-sm font-medium text-gray-700">Season</label>
                        <select id="season-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option>Kharif</option><option>Whole Year</option><option>Autumn</option><option>Rabi</option><option>Summer</option><option>Winter</option>
                        </select>
                    </div>

                    <div class="md:col-span-2 lg:col-span-1">
                        <label for="state-type" class="block text-sm font-medium text-gray-700">State</label>
                        <select id="state-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                           <option>Assam</option><option>Odisha</option><option>Andaman and Nicobar Islands</option><option>Andhra Pradesh</option><option>Arunachal Pradesh</option><option>Bihar</option><option>Chandigarh</option><option>Chhattisgarh</option><option>Goa</option><option>Gujarat</option><option>Haryana</option><option>Himachal Pradesh</option><option>Jammu and Kashmir </option><option>Jharkhand</option><option>Karnataka</option><option>Kerala</option><option>Madhya Pradesh</option><option>Maharashtra</option><option>Manipur</option><option>Meghalaya</option><option>Mizoram</option><option>Nagaland</option><option>Puducherry</option><option>Punjab</option><option>Rajasthan</option><option>Sikkim</option><option>Tamil Nadu</option><option>Telangana </option><option>Tripura</option><option>Uttar Pradesh</option><option>Uttarakhand</option><option>West Bengal</option>
                        </select>
                    </div>
                    
                    <!-- Numerical Features -->
                    <div>
                        <label for="crop-year" class="block text-sm font-medium text-gray-700">Crop Year</label>
                        <input type="number" id="crop-year" value="2024" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="area" class="block text-sm font-medium text-gray-700">Area (Hectares)</label>
                        <input type="number" id="area" value="50000" step="1000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="rainfall" class="block text-sm font-medium text-gray-700">Annual Rainfall (mm)</label>
                        <input type="number" id="rainfall" value="1500" step="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="fertilizer" class="block text-sm font-medium text-gray-700">Fertilizer (kg)</label>
                        <input type="number" id="fertilizer" value="700000" step="10000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div class="lg:col-span-2">
                        <label for="pesticide" class="block text-sm font-medium text-gray-700">Pesticide (kg)</label>
                        <input type="number" id="pesticide" value="20000" step="1000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
                
                <!-- Predict Button -->
                <div class="pt-6">
                    <button id="predict-button" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-200 flex items-center justify-center space-x-2 disabled:opacity-50">
                        <span>Predict Yield</span>
                        <div id="loading-spinner" class="spinner hidden"></div> <!-- Loading spinner -->
                    </button>
                </div>

                <!-- Output Section -->
                <div id="output-section" class="mt-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Prediction Result:</h3>
                    <div id="result-area" class="bg-gray-100 p-4 rounded-md text-gray-800">
                        <!-- Prediction or error will be shown here -->
                    </div>
                </div>

                <!-- * NEW * Section 2: Profit Estimation -->
                <div id="profit-section" class="mt-8 pt-6 border-t border-gray-200 hidden"> <!-- Initially hidden -->
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">2. Estimate Profit</h2>
                     <p class="text-sm text-gray-600 mb-6">
                        Enter your estimated selling price and farming cost to calculate potential profit based on the predicted yield and area.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                           <label for="selling-price" class="block text-sm font-medium text-gray-700">Est. Selling Price (₹ per Ton)</label>
                            <input type="number" id="selling-price" placeholder="e.g., 20000" step="100" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                        </div>
                         <div>
                           <label for="farming-cost" class="block text-sm font-medium text-gray-700">Est. Farming Cost (₹ per Hectare)</label>
                            <input type="number" id="farming-cost" placeholder="e.g., 30000" step="1000" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                        </div>
                    </div>
                    <!-- Calculate Profit Button -->
                     <div class="pt-6">
                        <button id="profit-button" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-200 disabled:opacity-50">
                            Calculate Estimated Profit
                        </button>
                    </div>
                    <!-- Profit Output -->
                     <div id="profit-output-section" class="mt-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Profit Estimation:</h3>
                        <div id="profit-result-area" class="bg-green-50 p-4 rounded-md text-gray-800">
                            <!-- Profit calculation will be shown here -->
                        </div>
                    </div>
                </div>

            </div>
        </div> <!-- End main content padding -->
    </div> <!-- End card -->

    <script>
        // --- Backend API URL ---
        const fastApiUrl = "http://127.0.0.1:8000/predict";

        // --- DOM References ---
        // Prediction Form
        const cropSelect = document.getElementById('crop-type');
        const seasonSelect = document.getElementById('season-type');
        const stateSelect = document.getElementById('state-type');
        const yearInput = document.getElementById('crop-year');
        const areaInput = document.getElementById('area'); // Needed for profit calc too
        const rainfallInput = document.getElementById('rainfall');
        const fertilizerInput = document.getElementById('fertilizer');
        const pesticideInput = document.getElementById('pesticide');
        const predictButton = document.getElementById('predict-button');
        const outputSection = document.getElementById('output-section');
        const resultArea = document.getElementById('result-area');
        const loadingSpinner = document.getElementById('loading-spinner');

        // * NEW * Profit Section References
        const profitSection = document.getElementById('profit-section');
        const sellingPriceInput = document.getElementById('selling-price');
        const farmingCostInput = document.getElementById('farming-cost');
        const profitButton = document.getElementById('profit-button');
        const profitOutputSection = document.getElementById('profit-output-section');
        const profitResultArea = document.getElementById('profit-result-area');

        // --- State Variable ---
        let currentPredictedYield = null; // To store the yield for profit calculation

        // --- Event Listeners ---
        predictButton.addEventListener('click', handlePrediction);
        profitButton.addEventListener('click', handleProfitCalculation); // * NEW * Listener for profit button

        // --- Prediction Function ---
        async function handlePrediction() {
            // Reset state
            predictButton.disabled = true;
            loadingSpinner.classList.remove('hidden');
            outputSection.classList.add('hidden'); 
            resultArea.textContent = ''; 
            profitSection.classList.add('hidden'); // * NEW * Hide profit section on new prediction
            profitOutputSection.classList.add('hidden'); // * NEW * Hide old profit result
            currentPredictedYield = null; // Reset stored yield

            // Collect and validate inputs (same as before)
            const payload = {
                Crop: cropSelect.value,
                Season: seasonSelect.value,
                State: stateSelect.value,
                Crop_Year: parseInt(yearInput.value, 10),
                Area: parseFloat(areaInput.value),
                Annual_Rainfall: parseFloat(rainfallInput.value),
                Fertilizer: parseFloat(fertilizerInput.value),
                Pesticide: parseFloat(pesticideInput.value)
            };
             for (const key in payload) { /* Validation code remains same */
                 const value = payload[key];
                 if (value === null || value === undefined || (typeof value === 'number' && isNaN(value))) {
                    displayResult(`Error: Invalid or missing value for '${key}'. Please check the form.`, true);
                    predictButton.disabled = false; loadingSpinner.classList.add('hidden'); return; 
                 }
                  if (['Crop_Year', 'Area', 'Annual_Rainfall', 'Fertilizer', 'Pesticide'].includes(key) && value < 0) {
                     displayResult(`Error: '${key}' cannot be negative.`, true);
                     predictButton.disabled = false; loadingSpinner.classList.add('hidden'); return;
                 }
            }

            // Call backend API (same as before)
            try {
                const response = await fetch(fastApiUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { /* Error handling remains same */
                    let errorMsg = `Error: ${response.status} ${response.statusText}`; try { const errData = await response.json(); if (errData.detail) { if (Array.isArray(errData.detail)) { errorMsg = `Error: Invalid input - ${errData.detail.map(e => `${e.loc[1]}: ${e.msg}`).join(', ')}`; } else { errorMsg = `Error: ${errData.detail}`; } } } catch (e) { /* Ignore */ } throw new Error(errorMsg); 
                }
                const result = await response.json();

                // Display result (modified to store yield)
                if (result.predicted_yield !== undefined) {
                    if (isNaN(result.predicted_yield) || result.predicted_yield === null) { 
                        console.error("Backend returned NaN or null:", result); 
                        displayResult("Prediction Result: NaN/Null. Cannot calculate profit.", true);
                    } else {
                         const yieldValue = parseFloat(result.predicted_yield); // Ensure it's a number
                         currentPredictedYield = yieldValue; // * NEW * Store the valid yield
                         displayResult(`Predicted Yield: ${yieldValue.toFixed(4)} tons/hectare`, false);
                         profitSection.classList.remove('hidden'); // * NEW * Show profit section if yield is valid
                    }
                } else if (result.error) { 
                     console.error("Backend returned an error field:", result); displayResult(`Error from backend: ${result.error}`, true);
                } else { 
                     console.error("Invalid response structure from API:", result); displayResult("Error: Invalid response structure from API.", true);
                }
            } catch (error) { /* Error handling remains same */
                console.error("Prediction failed (fetch or processing error):", error); if (error.message.includes('Failed to fetch')) { displayResult("Error: Could not connect to the backend API at " + fastApiUrl + ". Is it running? Check the URL and network.", true); } else { displayResult(error.message, true); }
            } finally {
                predictButton.disabled = false; loadingSpinner.classList.add('hidden');
            }
        }

        // --- * NEW * Profit Calculation Function ---
        function handleProfitCalculation() {
             profitOutputSection.classList.add('hidden'); // Hide previous result first
             profitResultArea.textContent = ''; // Clear old result

             // 1. Get inputs
             const pricePerTon = parseFloat(sellingPriceInput.value);
             const costPerHectare = parseFloat(farmingCostInput.value);
             const area = parseFloat(areaInput.value); // Get area from the main form

             // 2. Validate inputs
             if (isNaN(pricePerTon) || pricePerTon < 0) {
                 displayProfitResult("Error: Please enter a valid selling price (>= 0).", true);
                 return;
             }
             if (isNaN(costPerHectare) || costPerHectare < 0) {
                  displayProfitResult("Error: Please enter a valid farming cost (>= 0).", true);
                 return;
             }
             if (isNaN(area) || area <= 0) {
                 // Should have been caught earlier, but double-check
                  displayProfitResult("Error: Invalid area value from the main form.", true);
                  return;
             }
             if (currentPredictedYield === null || isNaN(currentPredictedYield)) {
                 // Should not happen if profit section is visible, but good check
                  displayProfitResult("Error: Cannot calculate profit without a valid yield prediction.", true);
                  return;
             }

             // 3. Perform calculation
             const totalYield = currentPredictedYield * area;
             const totalRevenue = totalYield * pricePerTon;
             const totalCost = costPerHectare * area;
             const estimatedProfit = totalRevenue - totalCost;

             // 4. Display result
             const resultString = `
                Total Predicted Yield: ${totalYield.toFixed(2)} tons (across ${area} hectares)\n
                Total Estimated Revenue: ₹ ${totalRevenue.toLocaleString('en-IN', { maximumFractionDigits: 0 })}\n
                Total Estimated Cost: ₹ ${totalCost.toLocaleString('en-IN', { maximumFractionDigits: 0 })}\n
                Estimated Profit / Loss: ₹ ${estimatedProfit.toLocaleString('en-IN', { maximumFractionDigits: 0 })}
            `;
             displayProfitResult(resultString, estimatedProfit < 0); // Mark as 'error' style if profit is negative (loss)
        }

        // --- Helper to display prediction result/error ---
        function displayResult(message, isError) {
            resultArea.textContent = message;
            if (isError) {
                resultArea.classList.remove('text-green-700', 'bg-green-100');
                resultArea.classList.add('text-red-700', 'bg-red-100'); 
                profitSection.classList.add('hidden'); // * NEW * Hide profit section if prediction fails
                profitOutputSection.classList.add('hidden');
                currentPredictedYield = null;
            } else {
                 resultArea.classList.remove('text-red-700', 'bg-red-100');
                 resultArea.classList.add('text-green-700', 'bg-green-100'); 
                 // Profit section is shown/hidden within handlePrediction now
            }
            outputSection.classList.remove('hidden'); 
        }

         // --- * NEW * Helper to display profit result/error ---
         function displayProfitResult(message, isLoss) {
             profitResultArea.textContent = message;
             // Use red style for errors OR negative profit (loss)
             if (isLoss) { 
                 profitResultArea.classList.remove('text-green-800', 'bg-green-100');
                 profitResultArea.classList.add('text-red-800', 'bg-red-100'); 
             } else {
                  profitResultArea.classList.remove('text-red-800', 'bg-red-100');
                  profitResultArea.classList.add('text-green-800', 'bg-green-100'); 
             }
             profitOutputSection.classList.remove('hidden'); // Show the profit output section
         }

    </script>

</body>
</html>

